@{
    ViewData["Title"] = "Product Management";
}

<div class="container mt-4">
    <h2>Product Management</h2>
    
    <div class="row">
        <div class="col-md-4">
            <h4>Create/Edit Product</h4>
            <form id="productForm">
                <input type="hidden" id="editProductId" value="">
                <div class="mb-3">
                    <label for="productName" class="form-label">Product Name</label>
                    <input type="text" class="form-control" id="productName" required>
                </div>
                
                <div class="mb-3">
                    <label for="productPrice" class="form-label">Price</label>
                    <input type="number" step="0.01" class="form-control" id="productPrice" required>
                </div>
                
                <div class="mb-3">
                    <label for="categoryId" class="form-label">Category</label>
                    <select class="form-control" id="categoryId" required>
                        <option value="">Loading categories...</option>
                    </select>
                </div>
                
                <div class="mb-3">
                    <label for="productImage" class="form-label">Product Image</label>
                    <input type="file" class="form-control" id="productImage" accept="image/*">
                    <small class="form-text text-muted">Leave empty to keep current image when editing</small>
                    <div id="currentImage" class="mt-2"></div>
                </div>
                
                <div class="d-flex gap-2">
                    <button type="submit" class="btn btn-primary flex-fill" id="productSubmitBtn">Create Product</button>
                    <button type="button" class="btn btn-secondary" id="productCancelBtn" style="display:none;">Cancel</button>
                </div>
            </form>
            
            <div id="message" class="mt-3"></div>
        </div>
        
        <div class="col-md-8">
            <h4>Products List</h4>
            <div id="productsList"></div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="~/js/app.js"></script>
    <script>
        // Load categories and products on page load
        $(document).ready(function() {
            loadCategories();
            loadProducts();
        });
        
        // Load categories from API (for dropdown only)
        function loadCategories() {
            $.ajax({
                url: `${API_BASE_URL}/categories`,
                method: 'GET',
                success: function(response) {
                    if (response.success && response.data) {
                        // Populate dropdown
                        const select = $('#categoryId');
                        select.empty();
                        select.append('<option value="">Select a category</option>');
                        response.data.forEach(function(category) {
                            select.append(`<option value="${category.id}">${category.name}</option>`);
                        });
                    } else {
                        showMessage('#message', 'Error loading categories: ' + (response.message || 'Unknown error'), 'danger');
                    }
                },
                error: function(xhr) {
                    let errorMsg = 'Failed to load categories.';
                    if (xhr.responseJSON && xhr.responseJSON.message) {
                        errorMsg = xhr.responseJSON.message;
                    }
                    showMessage('#message', errorMsg, 'danger');
                }
            });
        }
        
        // Load products from API
        function loadProducts() {
            $.ajax({
                url: `${API_BASE_URL}/products`,
                method: 'GET',
                success: function(response) {
                    if (response.success && response.data) {
                        displayProducts(response.data);
                    } else {
                        showMessage('#message', 'Error loading products: ' + (response.message || 'Unknown error'), 'danger');
                    }
                },
                error: function(xhr) {
                    let errorMsg = 'Failed to load products.';
                    if (xhr.responseJSON && xhr.responseJSON.message) {
                        errorMsg = xhr.responseJSON.message;
                    }
                    showMessage('#message', errorMsg, 'danger');
                }
            });
        }
        
        // Display products
        function displayProducts(products) {
            const container = $('#productsList');
            if (products.length === 0) {
                container.html('<p class="text-muted">No products found.</p>');
                return;
            }
            
            let html = '<div class="list-group">';
            products.forEach(function(product) {
                const productNameEscaped = escapeHtml(product.name);
                const categoryNameEscaped = escapeHtml(product.categoryName || 'N/A');
                const imageUrl = product.imageUrl ? `${API_BASE_URL.replace('/api', '')}${product.imageUrl}` : '';
                html += `
                    <div class="list-group-item" data-product-id="${product.id}">
                        <div class="d-flex w-100 justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <h5 class="mb-1">${productNameEscaped}</h5>
                                    <small class="text-muted">${formatCurrency(product.price)}</small>
                                </div>
                                <p class="mb-1 text-muted">Category: ${categoryNameEscaped}</p>
                                ${imageUrl ? `<img src="${imageUrl}" alt="${productNameEscaped}" class="img-thumbnail mt-2" style="max-width: 150px; max-height: 150px;">` : ''}
                            </div>
                            <div class="btn-group btn-group-sm ms-3">
                                <button class="btn btn-outline-primary btn-edit-product" data-product-id="${product.id}">Edit</button>
                                <button class="btn btn-outline-danger btn-delete-product" data-product-id="${product.id}" data-product-name="${productNameEscaped}">Delete</button>
                            </div>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            container.html(html);
            
            // Attach event listeners
            $(document).off('click', '.btn-edit-product').on('click', '.btn-edit-product', function() {
                const id = $(this).data('product-id');
                editProduct(id);
            });
            
            $(document).off('click', '.btn-delete-product').on('click', '.btn-delete-product', function() {
                const id = $(this).data('product-id');
                const name = $(this).data('product-name');
                deleteProduct(id, name);
            });
        }
        
        // Handle form submission
        $('#productForm').on('submit', function(e) {
            e.preventDefault();
            
            const productId = $('#editProductId').val();
            const formData = new FormData();
            formData.append('name', $('#productName').val());
            formData.append('price', $('#productPrice').val());
            formData.append('categoryId', $('#categoryId').val());
            
            const imageFile = $('#productImage')[0].files[0];
            if (imageFile) {
                formData.append('image', imageFile);
            }
            
            if (productId) {
                // Update product
                updateProduct(productId, formData);
            } else {
                // Create product
                createProduct(formData);
            }
        });
        
        // Cancel edit mode
        $('#productCancelBtn').on('click', function() {
            resetProductForm();
        });
        
        // Create product
        function createProduct(formData) {
            $.ajax({
                url: `${API_BASE_URL}/products`,
                method: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                success: function(response) {
                    if (response.success) {
                        showMessage('#message', 'Product created successfully!', 'success');
                        resetProductForm();
                        loadProducts();
                    } else {
                        const errorMsg = response.errorCode ? 
                            `Error (${response.errorCode}): ${response.message}` : 
                            response.message || 'Unknown error';
                        showMessage('#message', errorMsg, 'danger');
                    }
                },
                error: function(xhr) {
                    let errorMsg = 'Failed to create product.';
                    if (xhr.responseJSON) {
                        const response = xhr.responseJSON;
                        errorMsg = response.errorCode ? 
                            `Error (${response.errorCode}): ${response.message}` : 
                            response.message || errorMsg;
                    }
                    showMessage('#message', `HTTP ${xhr.status}: ${errorMsg}`, 'danger');
                }
            });
        }
        
        // Update product
        function updateProduct(id, formData) {
            $.ajax({
                url: `${API_BASE_URL}/products/${id}`,
                method: 'PUT',
                data: formData,
                processData: false,
                contentType: false,
                success: function(response) {
                    if (response.success) {
                        showMessage('#message', 'Product updated successfully!', 'success');
                        resetProductForm();
                        loadProducts();
                    } else {
                        const errorMsg = response.errorCode ? 
                            `Error (${response.errorCode}): ${response.message}` : 
                            response.message || 'Unknown error';
                        showMessage('#message', errorMsg, 'danger');
                    }
                },
                error: function(xhr) {
                    let errorMsg = 'Failed to update product.';
                    if (xhr.responseJSON) {
                        const response = xhr.responseJSON;
                        errorMsg = response.errorCode ? 
                            `Error (${response.errorCode}): ${response.message}` : 
                            response.message || errorMsg;
                    }
                    showMessage('#message', `HTTP ${xhr.status}: ${errorMsg}`, 'danger');
                }
            });
        }
        
        // Edit product
        function editProduct(id) {
            $.ajax({
                url: `${API_BASE_URL}/products/${id}`,
                method: 'GET',
                success: function(response) {
                    if (response.success && response.data) {
                        const product = response.data;
                        $('#editProductId').val(product.id);
                        $('#productName').val(product.name);
                        $('#productPrice').val(product.price);
                        $('#categoryId').val(product.categoryId);
                        
                        // Show current image
                        if (product.imageUrl) {
                            const imageUrl = `${API_BASE_URL.replace('/api', '')}${product.imageUrl}`;
                            $('#currentImage').html(`<img src="${imageUrl}" alt="${escapeHtml(product.name)}" class="img-thumbnail" style="max-width: 150px; max-height: 150px;"><br><small class="text-muted">Current image</small>`);
                        } else {
                            $('#currentImage').html('');
                        }
                        
                        $('#productSubmitBtn').text('Update Product');
                        $('#productCancelBtn').show();
                        $('#productImage').removeAttr('required');
                        $('html, body').animate({ scrollTop: 0 }, 'slow');
                    } else {
                        showMessage('#message', 'Failed to load product details.', 'danger');
                    }
                },
                error: function(xhr) {
                    showMessage('#message', 'Failed to load product details.', 'danger');
                }
            });
        }
        
        // Delete product
        function deleteProduct(id, name) {
            if (!confirm(`Are you sure you want to delete product "${name}"?`)) {
                return;
            }
            
            $.ajax({
                url: `${API_BASE_URL}/products/${id}`,
                method: 'DELETE',
                success: function(response) {
                    if (response.success) {
                        showMessage('#message', 'Product deleted successfully!', 'success');
                        loadProducts();
                    } else {
                        const errorMsg = response.errorCode ? 
                            `Error (${response.errorCode}): ${response.message}` : 
                            response.message || 'Unknown error';
                        showMessage('#message', errorMsg, 'danger');
                    }
                },
                error: function(xhr) {
                    let errorMsg = 'Failed to delete product.';
                    if (xhr.responseJSON) {
                        const response = xhr.responseJSON;
                        errorMsg = response.errorCode ? 
                            `Error (${response.errorCode}): ${response.message}` : 
                            response.message || errorMsg;
                    }
                    showMessage('#message', `HTTP ${xhr.status}: ${errorMsg}`, 'danger');
                }
            });
        }
        
        // Reset product form
        function resetProductForm() {
            $('#productForm')[0].reset();
            $('#editProductId').val('');
            $('#productSubmitBtn').text('Create Product');
            $('#productCancelBtn').hide();
            $('#productImage').attr('required', 'required');
            $('#currentImage').html('');
        }
    </script>
}

